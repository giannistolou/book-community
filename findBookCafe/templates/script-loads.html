<!-- GDPR Compliant Script Loading -->
<!-- Scripts will only load after user consent -->

<!-- Sentry (Functionality Category) - Load conditionally -->
<script>
// Function to load Sentry based on consent
function loadSentry() {
  if (window.hasConsentFor && window.hasConsentFor('functionality')) {
    // Check if Sentry is already loaded to prevent duplicate loading
    if (window.Sentry) {
      console.log('Sentry: Already loaded');
      return;
    }
    
    const script = document.createElement('script');
    script.src = "https://js-de.sentry-cdn.com/3b208bcd006ce709256308f182d0c37c.min.js";
    script.crossOrigin = "anonymous";
    script.onerror = function() {
      console.warn('Sentry: Failed to load (possibly blocked)');
    };
    script.onload = function() {
      try {
        Sentry.onLoad(function () {
          Sentry.init({
          });
        });
        console.log('Sentry: Loaded with user consent');
      } catch (e) {
        console.warn('Sentry: Error during initialization:', e);
      }
    };
    document.head.appendChild(script);
  }
}

// Function to load Google Analytics based on consent
function loadGoogleAnalytics() {
  if (window.hasConsentFor && window.hasConsentFor('analytics')) {
    // Check if Google Analytics is already loaded
    if (window.gtag || window.dataLayer) {
      console.log('Google Analytics: Already loaded');
      return;
    }
    
    try {
      // Google Analytics (gtag.js)
      const script1 = document.createElement('script');
      script1.async = true;
      script1.src = "https://www.googletagmanager.com/gtag/js?id=G-86MQLKEQCZ";
      script1.onerror = function() {
        console.warn('Google Analytics: Failed to load (possibly blocked by ad blocker)');
        if (!blockedServices.includes('Google Analytics')) {
          blockedServices.push('Google Analytics');
        }
      };
      script1.onload = function() {
        console.log('Google Analytics: Script loaded successfully');
      };
      document.head.appendChild(script1);

      const script2 = document.createElement('script');
      script2.innerHTML = `
        window.dataLayer = window.dataLayer || [];
        function gtag(){
          try {
            dataLayer.push(arguments);
          } catch(e) {
            console.warn('Google Analytics: Error pushing to dataLayer:', e);
          }
        }
        gtag('js', new Date());
        try {
          gtag('config', 'G-86MQLKEQCZ', {
            anonymize_ip: true,
            cookie_flags: 'SameSite=None;Secure'
          });
          console.log('Google Analytics: Configured with user consent');
        } catch(e) {
          console.warn('Google Analytics: Configuration error (possibly blocked):', e);
          if (!blockedServices.includes('Google Analytics')) {
            blockedServices.push('Google Analytics');
          }
        }
      `;
      document.head.appendChild(script2);
    } catch (e) {
      console.warn('Google Analytics: Error during setup:', e);
      if (!blockedServices.includes('Google Analytics')) {
        blockedServices.push('Google Analytics');
      }
    }
  }
}

// Function to load Microsoft Clarity based on consent
function loadClarity() {
  if (window.hasConsentFor && window.hasConsentFor('analytics')) {
    // Check if Clarity is already loaded
    if (window.clarity) {
      console.log('Microsoft Clarity: Already loaded');
      return;
    }
    
    try {
      const script = document.createElement('script');
      script.onerror = function() {
        console.warn('Microsoft Clarity: Failed to load (possibly blocked by ad blocker)');
        if (!blockedServices.includes('Microsoft Clarity')) {
          blockedServices.push('Microsoft Clarity');
        }
      };
      script.innerHTML = `
        try {
          (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            t.onerror = function() {
              console.warn('Microsoft Clarity: Tag script blocked');
              if (!window.blockedServices.includes('Microsoft Clarity')) {
                window.blockedServices.push('Microsoft Clarity');
              }
            };
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
          })(window, document, "clarity", "script", "sl12n9f03c");
          console.log('Microsoft Clarity: Loading with user consent');
        } catch(e) {
          console.warn('Microsoft Clarity: Error during initialization (possibly blocked):', e);
          if (!window.blockedServices.includes('Microsoft Clarity')) {
            window.blockedServices.push('Microsoft Clarity');
          }
        }
      `;
      document.head.appendChild(script);
    } catch (e) {
      console.warn('Microsoft Clarity: Error during setup:', e);
      if (!blockedServices.includes('Microsoft Clarity')) {
        blockedServices.push('Microsoft Clarity');
      }
    }
  }
}

// Function to load Mailchimp based on consent
function loadMailchimp() {
  console.log('loadMailchimp called, checking marketing consent...');
  console.log('Current consent state:', cookieConsent);
  
  const mcSignup = document.getElementById('mc_embed_signup');
  console.log('Found mc_embed_signup element:', mcSignup);
  
  if (window.hasConsentFor && window.hasConsentFor('marketing')) {
    // Show Mailchimp signup form
    if (mcSignup) {
      mcSignup.classList.add('show-newsletter');
      mcSignup.style.display = 'block';
      mcSignup.style.visibility = 'visible';
      console.log('Mailchimp: Newsletter signup form shown with user consent');
    } else {
      console.warn('Mailchimp: mc_embed_signup element not found in DOM');
    }
  } else {
    // Hide Mailchimp signup form
    if (mcSignup) {
      mcSignup.classList.remove('show-newsletter');
      mcSignup.style.display = 'none';
      console.log('Mailchimp: Newsletter signup form hidden (no marketing consent)');
    }
  }
}

// Load scripts based on initial consent state
function loadConsentBasedScripts() {
  // Reset blocked services array
  blockedServices = [];
  window.blockedServices = blockedServices;
  
  // Add small delays to prevent race conditions
  setTimeout(() => loadSentry(), 100);
  setTimeout(() => loadGoogleAnalytics(), 200); 
  setTimeout(() => loadClarity(), 300);
  setTimeout(() => loadMailchimp(), 500); // Increased delay for DOM readiness
  const APP_TYPE = '{{ type|default:"main" }}';
  const APP_CONFIGS = {
  blog: {
    gtag_id: '',
    clarity_id: '',
    plausible_domain: 'blog.book-community.com',
    sentry_dsn: 'https://3b208bcd006ce709256308f182d0c37c@sentry.io/123456',
    sentry_environment: 'blog'
  },
  cafe: {
     gtag_id: 'G-86MQLKEQCZ',
    clarity_id: 'sl12n9f03c',
    plausible_domain: 'cafe.book-community.com',
    sentry_dsn: 'https://cafe-sentry-dsn@sentry.io/456789', 
    sentry_environment: 'cafe'
  },
  main: {
    gtag_id: '',
    clarity_id: '',
    plausible_domain: 'book-community.com',
    sentry_dsn: 'https://3b208bcd006ce709256308f182d0c37c@sentry.io/123456',
    sentry_environment: 'main'
  }
};

// Get current app config
const currentAppConfig = APP_CONFIGS[APP_TYPE] || APP_CONFIGS.main;

console.log(`GDPR Scripts: Loading for app type "${APP_TYPE}"`);
console.log('App config:', currentAppConfig);
  // Check for blocked services after attempting to load
  setTimeout(() => {
    if (blockedServices.length > 0) {
      showBlockedServicesNotification();
    }
  }, 1500);
}

// Manual function to show newsletter (for debugging)
window.showNewsletterManually = function() {
  const mcSignup = document.getElementById('mc_embed_signup');
  if (mcSignup) {
    mcSignup.classList.add('show-newsletter');
    mcSignup.style.display = 'block';
    mcSignup.style.visibility = 'visible';
    console.log('Newsletter manually shown');
  } else {
    console.log('mc_embed_signup not found');
  }
};

// Manual function to check consent state (for debugging)
window.checkConsentState = function() {
  console.log('Current consent:', cookieConsent);
  console.log('Has marketing consent:', window.hasConsentFor('marketing'));
  console.log('mc_embed_signup element:', document.getElementById('mc_embed_signup'));
};

// Listen for cookie consent changes
if (window.addEventListener) {
  window.addEventListener('cookieConsentChanged', function(event) {
    console.log('Cookie consent changed:', event.detail);
    loadConsentBasedScripts();
  });
}

// Check consent on page load (with delay to ensure cookie consent library is loaded)
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    loadConsentBasedScripts();
  }, 1000);
  
});
</script>

<!-- GDPR Cookie Consent Banner -->
<style>
/* Initially hide Mailchimp form until consent is given */
#mc_embed_signup {
  display: none !important;
}

/* Show Mailchimp form when consent is given */
#mc_embed_signup.show-newsletter {
  display: block !important;
}

.gdpr-banner {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #F8F4E9 0%, #e3e1de 100%);
  color: #635642;
  padding: 25px;
  text-align: center;
  font-family: 'Lora', 'Georgia', serif;
  font-size: 15px;
  z-index: 10000;
  display: none;
  box-shadow: 0 -4px 20px rgba(99, 86, 66, 0.15);
  border-top: 3px solid #8B7355;
}

.gdpr-banner.show {
  display: block;
  animation: slideUp 0.5s ease-out;
}

@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}

.gdpr-banner p {
  margin: 0 0 20px 0;
  line-height: 1.6;
  max-width: 800px;
  margin-left: auto;
  margin-right: auto;
  font-weight: 400;
}

.gdpr-banner strong {
  color: #8B7355;
  font-weight: 600;
}

.gdpr-banner a {
  color: #8B7355;
  text-decoration: none;
  font-weight: 500;
  border-bottom: 1px solid transparent;
  transition: border-bottom 0.3s ease;
}

.gdpr-banner a:hover {
  border-bottom: 1px solid #8B7355;
}

.gdpr-buttons {
  display: flex;
  gap: 15px;
  justify-content: center;
  flex-wrap: wrap;
  max-width: 600px;
  margin: 0 auto;
}

.gdpr-btn {
  padding: 12px 24px;
  border: 2px solid transparent;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  font-family: 'Lora', 'Georgia', serif;
  transition: all 0.3s ease;
  min-width: 140px;
  position: relative;
  overflow: hidden;
}

.gdpr-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.gdpr-btn:hover::before {
  left: 100%;
}

.gdpr-btn-accept {
  background: linear-gradient(135deg, #8B7355 0%, #A0926B 100%);
  color: #F8F4E9;
  border-color: #8B7355;
}

.gdpr-btn-accept:hover {
  background: linear-gradient(135deg, #735F47 0%, #8B7355 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
}

.gdpr-btn-decline {
  background: linear-gradient(135deg, #e3e1de 0%, #d4d1cc 100%);
  color: #635642;
  border-color: #c9c5be;
}

.gdpr-btn-decline:hover {
  background: linear-gradient(135deg, #d4d1cc 0%, #c9c5be 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 86, 66, 0.2);
}

.gdpr-btn-settings {
  background: transparent;
  color: #8B7355;
  border-color: #8B7355;
}

.gdpr-btn-settings:hover {
  background: #8B7355;
  color: #F8F4E9;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
}

@media (max-width: 768px) {
  .gdpr-banner {
    padding: 20px 15px;
    font-size: 14px;
  }
  
  .gdpr-buttons {
    flex-direction: column;
    gap: 12px;
  }
  
  .gdpr-btn {
    padding: 14px 20px;
    font-size: 14px;
    min-width: auto;
    width: 100%;
    max-width: 280px;
    margin: 0 auto;
  }
}

/* Book-themed decorative elements */
.gdpr-banner::before {
  content: 'ğŸ“š';
  position: absolute;
  top: 10px;
  left: 20px;
  font-size: 24px;
  opacity: 0.3;
}

.gdpr-banner::after {
  content: 'ğŸ“–';
  position: absolute;
  top: 10px;
  right: 20px;
  font-size: 24px;
  opacity: 0.3;
}
</style>

<div id="gdprBanner" class="gdpr-banner">
  <p>
    ğŸª <strong>Î§ÏÎ®ÏƒÎ· Cookies</strong><br>
    Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ¼Îµ cookies Î³Î¹Î± Î½Î± Î²ÎµÎ»Ï„Î¹ÏÏƒÎ¿Ï…Î¼Îµ Ï„Î·Î½ ÎµÎ¼Ï€ÎµÎ¹ÏÎ¯Î± ÏƒÎ±Ï‚ ÏƒÏ„Î¿Î½ Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€ÏŒ Î¼Î±Ï‚. 
    ÎœÎµÏÎ¹ÎºÎ¬ cookies ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î± Î³Î¹Î± Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€Î¿Ï…, ÎµÎ½Ï Î¬Î»Î»Î± Î¼Î±Ï‚ Î²Î¿Î·Î¸Î¿ÏÎ½ 
    Î½Î± ÎºÎ±Ï„Î±Î½Î¿Î®ÏƒÎ¿Ï…Î¼Îµ Ï€ÏÏ‚ Î±Î»Î»Î·Î»ÎµÏ€Î¹Î´ÏÎ¬Ï„Îµ Î¼Îµ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½ÏŒ Î¼Î±Ï‚.
    <br>
    <a href="/privacy-policy" target="_blank">Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î‘Ï€Î¿ÏÏÎ®Ï„Î¿Ï…</a> | 
    <a href="/terms" target="_blank">ÎŒÏÎ¿Î¹ Î§ÏÎ®ÏƒÎ·Ï‚</a>
  </p>
  <div class="gdpr-buttons">
    <button class="gdpr-btn gdpr-btn-accept" onclick="acceptAllCookies()">
      Î‘Ï€Î¿Î´Î¿Ï‡Î® ÎŒÎ»Ï‰Î½
    </button>
    <button class="gdpr-btn gdpr-btn-decline" onclick="declineAllCookies()">
      ÎœÏŒÎ½Î¿ Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î±
    </button>
    <button class="gdpr-btn gdpr-btn-settings" onclick="showCookieSettings()">
      Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
    </button>
  </div>
</div>

<!-- Cookie Settings Modal -->
<style>
.cookie-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(99, 86, 66, 0.8);
  backdrop-filter: blur(5px);
  z-index: 10001;
  display: none;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease-out;
}

.cookie-modal.show {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.cookie-modal-content {
  background: linear-gradient(135deg, #F8F4E9 0%, #FEFBF3 100%);
  padding: 35px;
  border-radius: 12px;
  max-width: 650px;
  max-height: 85vh;
  overflow-y: auto;
  margin: 20px;
  position: relative;
  font-family: 'Lora', 'Georgia', serif;
  box-shadow: 0 20px 40px rgba(99, 86, 66, 0.3);
  border: 2px solid #e3e1de;
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from { transform: scale(0.9) translateY(20px); opacity: 0; }
  to { transform: scale(1) translateY(0); opacity: 1; }
}

.cookie-modal h2 {
  margin-top: 0;
  margin-bottom: 25px;
  color: #635642;
  font-size: 28px;
  font-weight: 600;
  text-align: center;
  position: relative;
  padding-bottom: 15px;
}

.cookie-modal h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 3px;
  background: linear-gradient(90deg, #8B7355, #A0926B);
  border-radius: 2px;
}

.cookie-category {
  margin: 25px 0;
  padding: 20px;
  border: 2px solid #e3e1de;
  border-radius: 8px;
  background: rgba(248, 244, 233, 0.5);
  transition: all 0.3s ease;
  position: relative;
}

.cookie-category:hover {
  border-color: #8B7355;
  background: rgba(248, 244, 233, 0.8);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(99, 86, 66, 0.1);
}

.cookie-category h3 {
  margin: 0 0 15px 0;
  color: #635642;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cookie-toggle {
  position: relative;
  display: inline-block;
  width: 58px;
  height: 30px;
}

.cookie-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.cookie-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #d4d1cc;
  transition: .4s ease;
  border-radius: 30px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.cookie-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background: linear-gradient(135deg, #F8F4E9 0%, #FEFBF3 100%);
  transition: .4s ease;
  border-radius: 50%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

input:checked + .cookie-slider {
  background: linear-gradient(135deg, #8B7355 0%, #A0926B 100%);
}

input:checked + .cookie-slider:before {
  transform: translateX(28px);
}

input:disabled + .cookie-slider {
  background: linear-gradient(135deg, #8B7355 0%, #A0926B 100%);
  opacity: 0.7;
  cursor: not-allowed;
}

.cookie-category p {
  margin: 12px 0;
  color: #6B5D4F;
  font-size: 15px;
  line-height: 1.5;
}

.cookie-category small {
  color: #8B7355;
  font-size: 13px;
  font-style: italic;
}

.cookie-modal-buttons {
  margin-top: 30px;
  text-align: center;
  display: flex;
  gap: 15px;
  justify-content: center;
  flex-wrap: wrap;
}

.close-modal {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  color: #A0926B;
  transition: all 0.3s ease;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.close-modal:hover {
  color: #635642;
  background: rgba(99, 86, 66, 0.1);
  transform: rotate(90deg);
}

/* Book decoration for modal */
.cookie-modal-content::before {
  content: 'ğŸ“š';
  position: absolute;
  top: 5px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 32px;
  background: #F8F4E9;
  padding: 5px 10px;
  border-radius: 50%;
  border: 2px solid #8B7355;
}

/* Responsive design for modal */
@media (max-width: 768px) {
  .cookie-modal-content {
    padding: 25px 20px;
    margin: 15px;
    max-height: 90vh;
  }
  
  .cookie-modal h2 {
    font-size: 24px;
  }
  
  .cookie-category {
    padding: 15px;
    margin: 20px 0;
  }
  
  .cookie-category h3 {
    font-size: 16px;
    flex-direction: column;
    gap: 10px;
    align-items: flex-start;
  }
  
  .cookie-toggle {
    align-self: flex-end;
  }
  
  .cookie-modal-buttons {
    flex-direction: column;
    gap: 12px;
  }
  
  .cookie-modal-buttons .gdpr-btn {
    width: 100%;
    max-width: none;
  }
}
</style>

<div id="cookieModal" class="cookie-modal">
  <div class="cookie-modal-content">
    <span class="close-modal" onclick="closeCookieSettings()">&times;</span>
    <h2 style="margin: 1rem 0; padding: 1rem 0;">Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Cookies</h2>
    
    <p style="text-align: center; margin-bottom: 25px; color: #6B5D4F;">
      Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„ÎµÎ¯Ï„Îµ Ï„Î¹Ï‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ±Ï‚ Î³Î¹Î± cookies. Î”Î¹Î±Î²Î¬ÏƒÏ„Îµ Ï„Î·Î½ 
      <a href="/privacy-policy" target="_blank" style="color: #8B7355; text-decoration: underline;">Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î‘Ï€Î¿ÏÏÎ®Ï„Î¿Ï…</a> 
      Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.
    </p>
    
    <div class="cookie-category">
      <h3>
        Î‘Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î± Cookies
        <label class="cookie-toggle">
          <input type="checkbox" id="necessary" checked disabled>
          <span class="cookie-slider"></span>
        </label>
      </h3>
      <p>Î‘Ï…Ï„Î¬ Ï„Î± cookies ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î± Î³Î¹Î± Ï„Î· Î²Î±ÏƒÎ¹ÎºÎ® Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€Î¿Ï… ÎºÎ±Î¹ Î´ÎµÎ½ Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î·Î¸Î¿ÏÎ½.</p>
      <small><strong>Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹:</strong> Î£Ï…Î½ÎµÎ´ÏÎ¯Î± Ï‡ÏÎ®ÏƒÏ„Î·, Î‘ÏƒÏ†Î¬Î»ÎµÎ¹Î±, Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ cookies</small>
    </div>

    <div class="cookie-category">
      <h3>
        Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒÏ„Î·Ï„Î±
        <label class="cookie-toggle">
          <input type="checkbox" id="functionality">
          <span class="cookie-slider"></span>
        </label>
      </h3>
      <p>Î‘Ï…Ï„Î¬ Ï„Î± cookies Î²Î¿Î·Î¸Î¿ÏÎ½ ÏƒÏ„Î·Î½ Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· ÏƒÏ†Î±Î»Î¼Î¬Ï„Ï‰Î½ ÎºÎ±Î¹ ÏƒÏ„Î· Î²ÎµÎ»Ï„Î¯Ï‰ÏƒÎ· Ï„Î·Ï‚ Î±Ï€ÏŒÎ´Î¿ÏƒÎ·Ï‚ Ï„Î¿Ï… Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€Î¿Ï….</p>
      <small><strong>Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹:</strong> Sentry Error Tracking</small>
    </div>

    <div class="cookie-category">
      <h3>
        Analytics & ÎœÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚
        <label class="cookie-toggle">
          <input type="checkbox" id="analytics">
          <span class="cookie-slider"></span>
        </label>
      </h3>
      <p>ÎœÎ±Ï‚ Î²Î¿Î·Î¸Î¿ÏÎ½ Î½Î± ÎºÎ±Ï„Î±Î½Î¿Î®ÏƒÎ¿Ï…Î¼Îµ Ï€ÏÏ‚ Î¿Î¹ ÎµÏ€Î¹ÏƒÎºÎ­Ï€Ï„ÎµÏ‚ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½ Ï„Î¿Î½ Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€ÏŒ Î¼Î±Ï‚.</p>
      <small><strong>Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹:</strong> Google Analytics, Microsoft Clarity</small>
    </div>

    <div class="cookie-category">
      <h3>
        Marketing & Newsletter  
        <label class="cookie-toggle">
          <input type="checkbox" id="marketing">
          <span class="cookie-slider"></span>
        </label>
      </h3>
      <p>Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î³Î¹Î± newsletter ÎºÎ±Î¹ Î´Î¹Î±Ï†Î·Î¼Î¹ÏƒÏ„Î¹ÎºÎ­Ï‚ ÎºÎ±Î¼Ï€Î¬Î½Î¹ÎµÏ‚.</p>
      <small><strong>Î ÎµÏÎ¹Î»Î±Î¼Î²Î¬Î½ÎµÎ¹:</strong> Mailchimp, Email Marketing</small>
    </div>

    <div class="cookie-modal-buttons">
      <button class="gdpr-btn gdpr-btn-accept" onclick="saveAndAcceptSelected()">
        Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÏ‰Î½
      </button>
      <button class="gdpr-btn gdpr-btn-decline" onclick="withdrawAllConsent(); closeCookieSettings();">
        Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· ÎŒÎ»Ï‰Î½
      </button>
      <button class="gdpr-btn gdpr-btn-settings" onclick="closeCookieSettings()">
        Î‘ÎºÏÏÏ‰ÏƒÎ·
      </button>
    </div>
    
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e3e1de; text-align: center;">
      <small style="color: #8B7355; font-size: 12px; line-height: 1.4;">
        ğŸ”’ <strong>Î¤Î± Î´Î¹ÎºÎ±Î¹ÏÎ¼Î±Ï„Î¬ ÏƒÎ±Ï‚:</strong> ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î±Î»Î»Î¬Î¾ÎµÏ„Îµ Ï„Î¹Ï‚ Ï€ÏÎ¿Ï„Î¹Î¼Î®ÏƒÎµÎ¹Ï‚ ÏƒÎ±Ï‚ Î±Î½Î¬ Ï€Î¬ÏƒÎ± ÏƒÏ„Î¹Î³Î¼Î®, 
        Î½Î± Î¶Î·Ï„Î®ÏƒÎµÏ„Îµ Î´Î¹Î±Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ÏƒÎ±Ï‚ Î® Î½Î± Î±Ï€Î¿ÏƒÏÏÎµÏ„Îµ Ï„Î· ÏƒÏ…Î³ÎºÎ±Ï„Î¬Î¸ÎµÏƒÎ® ÏƒÎ±Ï‚. 
        <br>Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÏ„Îµ Î¼Î±Î¶Î¯ Î¼Î±Ï‚ Î³Î¹Î± Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Ï€Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚.
      </small>
    </div>
  </div>
</div>

<script>
// Cookie consent management
let cookieConsent = {
  necessary: true,
  functionality: false,
  analytics: false,
  marketing: false
};

// Track which services were blocked
let blockedServices = [];

// Check if consent already exists and is still valid
function checkExistingConsent() {
  const consent = localStorage.getItem('book_community_cookie_consent');
  const consentDate = localStorage.getItem('book_community_cookie_consent_date');
  
  if (consent && consentDate) {
    try {
      const savedDate = new Date(consentDate);
      const now = new Date();
      const daysDiff = (now - savedDate) / (1000 * 60 * 60 * 24);
      
      // GDPR: Consent expires after 12 months (365 days)
      if (daysDiff > 365) {
        console.log('Cookie consent expired, requesting new consent');
        localStorage.removeItem('book_community_cookie_consent');
        localStorage.removeItem('book_community_cookie_consent_date');
        return false;
      }
      
      cookieConsent = JSON.parse(consent);
      return true;
    } catch (e) {
      console.error('Error parsing cookie consent:', e);
      localStorage.removeItem('book_community_cookie_consent');
      localStorage.removeItem('book_community_cookie_consent_date');
    }
  }
  return false;
}

// Show notification for blocked services
function showBlockedServicesNotification() {
  if (blockedServices.length > 0) {
    const notification = document.createElement('div');
    notification.className = 'blocked-services-notification';
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-icon">ğŸ›¡ï¸</span>
        <span class="notification-text">
          ÎœÎµÏÎ¹ÎºÎ­Ï‚ Ï…Ï€Î·ÏÎµÏƒÎ¯ÎµÏ‚ Î±Î½Î±Î»Ï…Ï„Î¹ÎºÏÎ½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ Î­Ï‡Î¿Ï…Î½ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„ÎµÎ¯ Î±Ï€ÏŒ Ï„Î¿Î½ ad blocker ÏƒÎ±Ï‚.
          <br><small>Î‘Ï…Ï„ÏŒ Î´ÎµÎ½ ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÎ¹ Ï„Î· Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Ï„Î¿Ï… Î¹ÏƒÏ„ÏŒÏ„Î¿Ï€Î¿Ï….</small>
        </span>
        <button class="notification-close" onclick="hideBlockedNotification()">Ã—</button>
      </div>
    `;
    
    // Add styles for the notification
    const style = document.createElement('style');
    style.innerHTML = `
      .blocked-services-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #F8F4E9 0%, #e3e1de 100%);
        color: #635642;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(99, 86, 66, 0.2);
        border: 2px solid #8B7355;
        z-index: 10002;
        max-width: 350px;
        font-family: 'Lora', 'Georgia', serif;
        font-size: 14px;
        animation: slideInRight 0.5s ease-out;
      }
      
      @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      .notification-content {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      
      .notification-icon {
        font-size: 20px;
      }
      
      .notification-text {
        flex: 1;
        line-height: 1.4;
      }
      
      .notification-close {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: #8B7355;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s ease;
      }
      
      .notification-close:hover {
        background: rgba(139, 115, 85, 0.1);
      }
      
      @media (max-width: 768px) {
        .blocked-services-notification {
          top: 10px;
          right: 10px;
          left: 10px;
          max-width: none;
        }
      }
    `;
    document.head.appendChild(style);
    document.body.appendChild(notification);
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
      hideBlockedNotification();
    }, 8000);
  }
}

// Hide blocked services notification
function hideBlockedNotification() {
  const notification = document.querySelector('.blocked-services-notification');
  if (notification) {
    notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
    setTimeout(() => {
      notification.remove();
    }, 300);
  }
}

// Add slideOutRight animation
document.addEventListener('DOMContentLoaded', function() {
  const style = document.createElement('style');
  style.innerHTML = `
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
});

// Show banner if no consent exists
function showBannerIfNeeded() {
  if (!checkExistingConsent()) {
    document.getElementById('gdprBanner').classList.add('show');
  } else {
    // Load scripts based on existing consent
    loadConsentBasedScripts();
    // Check for blocked services after a delay
    setTimeout(() => {
      showBlockedServicesNotification();
    }, 2000);
  }
}

// Hide banner
function hideBanner() {
  document.getElementById('gdprBanner').classList.remove('show');
}

// Accept all cookies
function acceptAllCookies() {
  cookieConsent = {
    necessary: true,
    functionality: true,
    analytics: true,
    marketing: true
  };
  saveConsent();
  hideBanner();
  loadConsentBasedScripts();
}

// Decline all cookies (only necessary)
function declineAllCookies() {
  cookieConsent = {
    necessary: true,
    functionality: false,
    analytics: false,
    marketing: false
  };
  saveConsent();
  hideBanner();
  loadConsentBasedScripts();
}

// Show cookie settings modal
function showCookieSettings() {
  // Load current preferences
  document.getElementById('functionality').checked = cookieConsent.functionality;
  document.getElementById('analytics').checked = cookieConsent.analytics;
  document.getElementById('marketing').checked = cookieConsent.marketing;
  
  document.getElementById('cookieModal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

// Close cookie settings modal
function closeCookieSettings() {
  document.getElementById('cookieModal').classList.remove('show');
  document.body.style.overflow = '';
}

// Save selected preferences
function saveAndAcceptSelected() {
  cookieConsent = {
    necessary: true,
    functionality: document.getElementById('functionality').checked,
    analytics: document.getElementById('analytics').checked,
    marketing: document.getElementById('marketing').checked
  };
  saveConsent();
  closeCookieSettings();
  hideBanner();
  loadConsentBasedScripts();
}

// Save consent to localStorage with timestamp
function saveConsent() {
  localStorage.setItem('book_community_cookie_consent', JSON.stringify(cookieConsent));
  localStorage.setItem('book_community_cookie_consent_date', new Date().toISOString());
  
  // Dispatch event for other scripts to listen to
  window.dispatchEvent(new CustomEvent('cookieConsentChanged', { 
    detail: cookieConsent 
  }));
  
  console.log('GDPR: Consent saved with timestamp');
}

// Global function to check consent
window.hasConsentFor = function(category) {
  return cookieConsent[category] === true;
};

// GDPR: Function to get consent record (for audit purposes)
window.getConsentRecord = function() {
  const consent = localStorage.getItem('book_community_cookie_consent');
  const date = localStorage.getItem('book_community_cookie_consent_date');
  
  if (consent && date) {
    return {
      consent: JSON.parse(consent),
      timestamp: date,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
  }
  return null;
};

// GDPR: Function to withdraw all consent
window.withdrawAllConsent = function() {
  cookieConsent = {
    necessary: true,
    functionality: false,
    analytics: false,
    marketing: false
  };
  saveConsent();
  loadConsentBasedScripts();
  console.log('GDPR: All non-essential consent withdrawn');
};

// Initialize banner on page load
document.addEventListener('DOMContentLoaded', function() {
  showBannerIfNeeded();
});

// Close modal when clicking outside
document.getElementById('cookieModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCookieSettings();
  }
});
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = "//cdn-images.mailchimp.com/embedcode/classic-071822.css";
    document.head.appendChild(link);
  });
</script>
